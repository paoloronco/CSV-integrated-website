<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV Data Table Demo (External CSV)</title>
  <style>
    :root{--bg:#0b1020;--card:#141a2e;--muted:#8fa3c7;--text:#eaf1ff;--accent:#5ea0ff;--border:#24304f}
    html,body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
    .wrap{max-width:1100px;margin:48px auto;padding:0 20px}
    h1{font-size:28px;margin:0 0 12px}
    p.muted{color:var(--muted);margin:0 0 20px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
    input[type="search"]{flex:1;min-width:240px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0e152b;color:var(--text)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#0e152b;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    thead th{position:sticky;top:0;background:#121832;padding:10px;border-bottom:1px solid var(--border);font-weight:600;cursor:pointer;user-select:none}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:hover{background:#10162c}
    a{color:var(--accent);text-decoration:none}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    select{padding:8px;border-radius:10px;background:#0e152b;border:1px solid var(--border);color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CSV Data Table Demo — External CSV</h1>
    <p class="muted" id="hint">Tip: click column headers to sort ↑↓</p>

    <div class="controls" role="region" aria-label="Table controls">
      <input id="q" type="search" placeholder="Search… (name, category, tags…)" title="Search across all columns" />
      <label title="Rows per page">Rows:
        <select id="rpp">
          <option>10</option><option selected>25</option><option>50</option><option>100</option>
        </select>
      </label>
      <button id="export" class="btn">⬇️ Export filtered to CSV</button>
      <span id="pageinfo" class="badge">Page 1/1</span>
    
    <div class="controls" style="margin-top:6px; gap:10px;">
      <input id="csvurl" type="url" placeholder="Or paste CSV URL or filename…" style="flex:1;min-width:260px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0e152b;color:var(--text)" />
      <input id="csvfile" type="file" accept=".csv,text/csv" class="btn" />
    </div>
    <p class="muted" id="errmsg" style="display:none"></p>


    <div style="overflow:auto;border-radius:16px">
      <table id="grid" aria-describedby="hint">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">
      <div><button class="btn" id="prev">← Prev</button> <button class="btn" id="next">Next →</button></div>
      <div class="badge" id="count">0 rows</div>
    </div>
  </div>

<script>
/* --------- CSV PARSER (robust; handles quotes, commas, CRLF) --------- */
function parseCSV(text){
  const rows=[];let r=[],field="",inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='"' && n==='"'){ field+='"'; i++; }
      else if(c==='"'){ inQ=false; }
      else{ field+=c; }
    }else{
      if(c==='"'){ inQ=true; }
      else if(c===','){ r.push(field); field=""; }
      else if(c==='\n'){ r.push(field); rows.push(r); r=[]; field=""; }
      else if(c==='\r'){ /* ignore */ }
      else{ field+=c; }
    }
  }
  if(field.length || r.length) { r.push(field); rows.push(r); }
  return rows;
}

/* --------- UTILITIES --------- */
const $ = s=>document.querySelector(s);
const create = (tag, props={}, ...kids) => {
  const el = Object.assign(document.createElement(tag), props);
  for(const k of kids) el.append(k);
  return el;
};
function toCSV(rows){
  return rows.map(r => r.map(v => {
    v = (v??"").toString();
    return /[",\n]/.test(v) ? '"' + v.replace(/"/g,'""') + '"' : v;
  }).join(",")).join("\n");
}

/* --------- STATE --------- */
let headers=[], data=[], view=[], sortKey=0, sortDir=1, page=1, rpp=25;

/* --------- RENDER --------- */
function renderHead(){
  const tr = create('tr');
  headers.forEach((h,idx)=>{
    const th = create('th', {textContent: h, title: 'Sort by ' + (h||`Col ${idx+1}`)});
    th.addEventListener('click', ()=>{ sortKey=idx; sortDir*=-1; apply(); });
    tr.append(th);
  });
  $('#grid thead').innerHTML = ""; $('#grid thead').append(tr);
}
function renderBody(){
  const start=(page-1)*rpp, end=start+rpp;
  const slice=view.slice(start,end);
  const frag = document.createDocumentFragment();
  for(const row of slice){
    const tr = create('tr');
    row.forEach((cell,idx)=>{
      const td = create('td');
      if(headers[idx]==='Link' && cell){
        const a = create('a', {href:cell, target:'_blank'}); a.textContent='Open link'; td.append(a);
      } else {
        td.textContent = cell;
      }
      tr.append(td);
    });
    frag.append(tr);
  }
  const tb = $('#grid tbody'); tb.innerHTML=""; tb.append(frag);
  const totalPages = Math.max(1, Math.ceil(view.length / rpp));
  $('#pageinfo').textContent = `Page ${page}/${totalPages} • ${view.length} rows`;
  $('#count').textContent = `${data.length} total rows`;
}
function apply(){
  const q = $('#q').value.trim().toLowerCase();
  view = data.filter(r => q==="" || r.some(v => (v??"").toString().toLowerCase().includes(q)));
  view.sort((a,b)=> (a[sortKey]??"").toString().localeCompare((b[sortKey]??"").toString(), undefined, {numeric:true}) * sortDir);
  page=1;
  renderBody();
}

/* --------- UI EVENTS --------- */
$('#q').addEventListener('input', apply);
$('#rpp').addEventListener('change', (e)=>{ rpp = parseInt(e.target.value,10)||25; apply(); });
$('#prev').addEventListener('click', ()=>{ if(page>1){ page--; renderBody(); } });
$('#next').addEventListener('click', ()=>{
  const totalPages = Math.max(1, Math.ceil(view.length / rpp));
  if(page<totalPages){ page++; renderBody(); }
});
$('#export').addEventListener('click', ()=>{
  const out = [headers, ...view];
  const blob = new Blob([toCSV(out)], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'filtered-table.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});


/* --------- BOOTSTRAP --------- */
function getParam(name){
  const m = new URLSearchParams(location.search).get(name);
  return (m && m.trim()) || null;
}
function showError(msg){
  const el = document.getElementById('errmsg');
  el.style.display = 'block';
  el.textContent = 'Error: ' + msg + ' — Tip: if you opened this page via file://, use the file picker above or run a local server.';
  console.error(msg);
}
async function loadViaFetch(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('Failed to load CSV ('+r.status+') at ' + url);
  return await r.text();
}
function loadFromText(t){
  const rows = parseCSV(t).filter(r=>r.length && r.some(c=>c!==''));
  headers = rows.shift() || [];
  data = rows;
  renderHead(); apply();
}
async function bootstrap(){
  try{
    const override = getParam('csv');
    const urlInput = document.getElementById('csvurl');
    if(override){ urlInput.value = override; }
    const url = override || './mock-data.csv';
    const text = await loadViaFetch(url);
    loadFromText(text);
  }catch(err){
    showError(String(err));
  }
}
/* URL input: allow loading arbitrary CSV (same-origin on GitHub Pages or CORS-enabled) */
document.getElementById('csvurl').addEventListener('change', async (e)=>{
  try{
    const url = e.target.value.trim();
    if(!url) return;
    const text = await loadViaFetch(url);
    loadFromText(text);
    document.getElementById('errmsg').style.display = 'none';
  }catch(err){ showError(String(err)); }
});
/* File picker fallback: works with file:// */
document.getElementById('csvfile').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => { loadFromText(ev.target.result); document.getElementById('errmsg').style.display = 'none'; };
  reader.onerror = () => showError('Could not read selected file.');
  reader.readAsText(f);
});
bootstrap();
</script>

</body>
</html>
